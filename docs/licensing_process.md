# Процесс лицензирования

## Обзор

Данный документ описывает процесс лицензирования приложения, основанный на полуавтоматической активации с использованием асимметричной криптографии и привязки к устройству. Этот подход обеспечивает баланс между удобством пользователя и защитой от несанкционированного распространения лицензий.

## Схема работы

### 1. Первичная выдача лицензии

1. Пользователь оплачивает лицензию через Telegram-бота
2. Telegram-бот генерирует первичный ключ активации
3. Первичный ключ отправляется пользователю в формате `XXXX-XXXX-XXXX-XXXX`

### 2. Генерация запроса активации

1. Пользователь вводит первичный ключ в приложение
2. Приложение собирает уникальный идентификатор устройства, который включает:
   - Идентификатор устройства (Android ID, IDFV для iOS)
   - Модель устройства
   - Имя устройства
   - MAC-адрес (если доступен)
3. Собранная информация хешируется с использованием SHA-256
4. Приложение генерирует запрос активации, объединяя первичный ключ и хеш устройства
5. Приложение показывает пользователю код запроса активации

### 3. Обмен через Telegram

1. Пользователь отправляет код запроса активации в Telegram-бот
2. Бот дешифрует код и извлекает данные об устройстве
3. Бот создает файл лицензии, включающий:
   - Информацию о пользователе
   - Дату активации
   - Идентификатор устройства (в зашифрованном виде)
   - Тип лицензии и доступные функции
4. Бот подписывает лицензию приватным ключом
5. Подписанный файл лицензии отправляется пользователю

### 4. Активация лицензии

1. Пользователь импортирует файл лицензии в приложение
2. Приложение проверяет подпись с помощью публичного ключа (встроенного в приложение)
3. Приложение проверяет, соответствует ли текущее устройство тому, для которого была создана лицензия
4. В случае успешной проверки, лицензия активируется и сохраняется в защищенном хранилище

### 5. Проверка лицензии при запуске

1. При каждом запуске приложение проверяет:
   - Валидность подписи лицензии
   - Соответствие идентификатора устройства
   - Срок действия лицензии (если применимо)
2. Если какая-либо из проверок не пройдена, приложение ограничивает функциональность

## Технические детали

### Формат лицензионного файла

Лицензионный файл представляет собой JSON, содержащий следующие поля:
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "appId": "com.example.myapp",
  "createdAt": "2024-07-25T14:30:00Z",
  "expirationDate": "2025-07-25T14:30:00Z",
  "type": "enterprise",
  "features": {
    "maxUsers": 50,
    "modules": ["analytics", "reporting"]
  },
  "metadata": {
    "clientName": "Example Corp"
    "dsignature": "Base64EncodedSignature..."
  },
  "signature": "Base64EncodedSignature..."
}

### Криптография

- Для асимметричной криптографии используется алгоритм RSA с ключом 2048 бит или ECC с ключом 256 бит
- Для хеширования используется SHA-512
- Для защищенного хранения на устройстве используется flutter_secure_storage

## Дополнительные меры защиты

### Защита от переноса лицензии

1. Часть лицензионной информации хранится в защищенном хранилище устройства
2. Приложение создает "якорь" в системных настройках устройства
3. Данные приложения частично шифруются ключом, производным от идентификатора устройства

### Защита от взлома приложения

1. Проверка целостности приложения при запуске
2. Обфускация кода для усложнения анализа
3. Множественные проверки лицензии в разных частях кода

## Преимущества подхода

1. **Офлайн работа**: после активации лицензии интернет-соединение не требуется
2. **Защита от перепродажи**: каждая лицензия привязана к конкретному устройству
3. **Контроль активаций**: все активации проходят через Telegram-бота, что позволяет отслеживать подозрительную активность
4. **Надежность**: даже при наличии доступа к исходному коду приложения, генерация валидных лицензий невозможна без приватного ключа
5. **Удобство для пользователя**: процесс активации прост и понятен
