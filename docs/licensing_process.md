# Процесс лицензирования MoniPlan

## Обзор

Данный документ описывает процесс лицензирования приложения MoniPlan, основанный на криптографической защите с использованием асимметричного шифрования и привязки к устройству. Этот подход обеспечивает надежную защиту от несанкционированного использования при сохранении удобства для конечного пользователя.

## Схема работы

### 1. Генерация запроса лицензии

1. Пользователь запускает процесс получения лицензии в приложении
2. Приложение собирает хеш данных устройства, который включает:
   - Идентификатор устройства (Android ID для Android, IDFV для iOS)
   - Модель устройства
   - Имя устройства
   - MAC-адрес (если доступен)
3. Приложение создает [json запроса лицензии](#формат-запроса-лицензии)
   - Хеш данных устройства
   - Идентификатор приложения
   - Дата и время создания запроса в формате ISO 8601 (например, "2024-07-25T14:30:00Z")
   - Дата и время истечения срока действия запроса в формате ISO 8601 (обычно +48 часов)
5. Полученный json шифруется с использованием публичного ключа 
6. Зашифрованный json преобразуется в байты и сохраняется в файл запроса лицензии
7. Приложение открывает диалоговое окно "Поделиться" для отправки файла запроса

### 2. Обработка запроса и выдача лицензии

1. Пользователь отправляет файл запроса лицензии на бэкенд (через Telegram-бота или другой канал)
2. Бэкенд расшифровывает запрос с помощью приватного ключа
3. Бэкенд проверяет дату истечения срока запроса и отклоняет устаревшие запросы
4. Бэкенд извлекает и сохраняет данные об устройстве пользователя
5. Бэкенд создает [файл лицензии](#формат-лицензионного-файла)
6. Бэкенд подписывает лицензию приватным ключом
7. Подписанный файл лицензии отправляется пользователю

### 3. Активация лицензии

1. Пользователь импортирует файл лицензии в приложение
2. Приложение читает файл лицензии и расшифровывает сигнатуру получая хеш данных
3. Пакет licensify хеширует данные лицензии и сравнивает с полученным из сигнатуры хешем
4. Если хеши совпадают, то приложение собирает текущие данные устройства и генерирует новый хеш
   - Если хеши не совпадают, то приложение сообщает, что лицензия невалидна
5. Приложение сравнивает полученный хеш устройства с хешем в метаданных лицензии
   - Если хеши совпадают, лицензия активируется и сохраняется в защищенном хранилище
   - Если хеши не совпадают, приложение сообщает, что лицензия активирована на другом устройстве

### 4. Проверка лицензии при запуске

1. При каждом запуске приложение проверяет:
   - Валидность подписи лицензии
   - Соответствие идентификатора устройства
   - Срок действия лицензии (если применимо)
2. Если какая-либо из проверок не пройдена, приложение ограничивает функциональность

## Технические детали

### Формат лицензионного файла

Лицензионный файл представляет собой JSON, содержащий следующие поля:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "appId": "com.moniplan.app",
  "createdAt": "2024-07-25T14:30:00Z",
  "expirationDate": "2025-07-25T14:30:00Z",
  "type": "standart",
  "features": {
    "monisyncBackupPassword": false,
    "monisyncExportData": false,
    "analyticsInsights": false,
    "plannerAllowMany": false
  },
  "metadata": {
    "deviceHash": "Base64EncodedSignature...",
    "userHash": "Base64EncodedSignature..."
  },
  "signature": "Base64EncodedSignature..."
}
```

### Формат запроса лицензии

Запрос лицензии представляет собой зашифрованную строку данных, которая после расшифровки имеет следующий формат JSON:
```json
{
  "deviceHash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
  "appId": "com.moniplan.app",
  "createdAt": "2024-07-25T14:30:00Z",
  "expiresAt": "2024-07-27T14:30:00Z",
}
```

Этот JSON-объект шифруется публичным ключом и передается в виде файла с расширением `.mlr` (MoniPlan License Request).

### Криптография

- Для асимметричной криптографии используется алгоритм RSA с ключом 2048 бит или ECC с ключом 256 бит
- Для хеширования используется SHA-512
- Для защищенного хранения на устройстве используется flutter_secure_storage

## Преимущества подхода

1. **Офлайн работа**: после активации лицензии интернет-соединение не требуется
2. **Защита от перепродажи**: каждая лицензия привязана к конкретному устройству
3. **Контроль активаций**: все активации проходят через бэкенд, что позволяет отслеживать подозрительную активность
4. **Надежность**: даже при наличии доступа к исходному коду приложения, генерация валидных лицензий невозможна без приватного ключа
5. **Удобство для пользователя**: процесс активации прост и понятен